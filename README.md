# AGV (PiCar + Robot Arm) 프로젝트 - ARMEX

## 소개
본 프로젝트는 Raspberry Pi 기반의 자율주행 로봇차량(PiCar)과 로봇 팔(Robot Arm)을 결합하여 자동으로 물체를 운반 및 적재하는 AGV(Automated Guided Vehicle)를 구현한 시스템입니다.  
PiCar는 라인 트레이싱을 통해 목적지까지 주행하며, Robot Arm은 물체 집기 및 적재 동작을 수행합니다.  
MQTT 통신을 활용하여 PC, PiCar와 Robot Arm, 그리고 아두이노 카(적재 플랫폼) 간 실시간 명령 교환이 이루어집니다.  
또한, C# 기반 PC UI 애플리케이션을 통해 공장 현장의 주문 관리, 긴급 정지, 모니터링 및 데이터 시각화를 지원합니다.

---

## 주요 기능
- PiCar 라인 센서 기반 라인 트레이싱 주행 및 목적지 자동 정지  
- Robot Arm 물체 집기 및 적재 동작 수행  
- MQTT를 이용한 PiCar, Robot Arm, 아두이노 카 간 실시간 명령 교환  
- 초음파 센서 기반 장애물 감지 및 즉시 정지 기능  
- 아두이노 카 컨베이어 벨트 및 서보 게이트 제어  
- PC UI에서 주문 현황 관리 및 실시간 영상 감시 (YOLO 객체 탐지 포함)  
- 긴급 정지 버튼 및 시스템 재가동 기능  
- 주문별 처리 상태 및 완성된 주문 내역 시각화 (LiveCharts)  
- 카메라 노출 조절 및 주문별 제품 필터링  
- 긴급 상황 발생 시 이미지 포함 로그 저장 및 상세 조회 기능

---

# Armex 프로젝트: 전체 시스템 개요 및 작동 순서

## 1. 컨베이어 벨트 시스템

- 컨베이어 벨트는 **T자 형태**로 구성되어 있습니다.  
- 물체는 1번 벨트를 따라 이동하며, 윗면에 설치된 카메라가 물체를 촬영하여 **YOLO 객체 인식**을 수행합니다.  
- 들어온 주문에 해당하는 물체가 감지되면, 서보모터가 작동하여 물체를 2번 벨트로 분리합니다.  
- 2번 벨트로 이동한 물체는 옆면에 부착된 **‘+’자 형태로** **로봇팔에 장착된 카메라 ROI 영역** 안으로 들어오게 됩니다.

## 2. 로봇팔 + AGV (PiCar) 협동 작업
- 초기 상태엔 로봇팔은 카메라가 켜져 있습니다.
- 로봇팔 카메라가 ‘+’자 이미지를 ROI 안에 들어온것을 인식하면, 로봇팔은 물체 집기 동작을 수행합니다.
- Robot Arm이 물체 집기 동작을 완료하면 **‘MOVE_BACKWARD’ 메시지**로 PiCar에 완료를 알립니다.    
- PiCar가 후진하여 아두이노 카 옆으로 이동합니다.  
- Robot Arm에 **‘PUT’ 명령**을 보내 물체를 아두이노 카 위에 적재합니다.  
- 작업 완료 후 PiCar가 다시 전진하며 라인 트레이싱을 재개합니다.
- PiCar는 라인 센서를 이용하여 라인 트레이싱으로 목적지까지 전진합니다.    
- 시스템은 대기 상태를 유지하며, 장애물 감지 시 즉시 정지합니다.
- 이후 로봇팔은 **‘GRAB’ 명령**을 받고 카메라를 활성화 시키며 물체가 올 때 까지 대기를 합니다.

---

## 설치 및 실행 방법

### 필요 환경
- Raspberry Pi 4 이상 (PiCar, Robot Arm 제어)  
- MQTT Broker (예: Mosquitto)  
- 아두이노 UNO 및 ESP8266 모듈  
- Windows PC (C# UI 실행용)

### 실행 순서
1. MQTT Broker 실행 및 IP 주소 확인  
2. PiCar: `python Picar.py` 실행  
3. Robot Arm: `python Robot_Arm_Main.py` 실행  
4. 아두이노 실행  
5. Windows PC에서 `ARMEX` UI 실행 및 로그인

---

## UI 애플리케이션 기능

### 로그인 및 사용자 권한 관리
- 최초 로그인은 관리자만 가능  
- 관리자, 일반 사용자 권한별 탭 및 기능 접근 제어

### 실시간 주문 현황 관리
- 현재 주문 목록 조회 및 차량별 주문 강조 표시  
- 주문 처리 상태 실시간 업데이트 및 DB 연동  
- 주문별 제품 필터링 및 처리 내역 관리

### 영상 모니터링 및 객체 탐지
- 공장 내 설치된 2대 카메라 영상 실시간 표시  
- YOLO 기반 객체 탐지 및 탐지된 제품명 표시  
- 탐지 시 해당 제품 처리용 게이트 자동 제어 (서보모터)

### 긴급 정지 및 재가동
- 긴급 정지 버튼 클릭 시 즉시 벨트 및 모터 정지  
- 발생한 긴급 상황 로그와 카메라 캡처 이미지 DB 저장  
- 관리자만 시스템 재가동 가능 (긴급상태 해제 및 기기 재동작)

### 차트 및 통계
- 제품별 연도별 누적 판매량 막대 그래프 표시 (LiveCharts 사용)  
- 제품별 누적 데이터 간편 조회 및 이전/다음 버튼 지원

### 주문 완료 내역 조회
- 처리 완료된 주문 목록 조회  
- 주문별 상태 및 수량 확인 가능

### 카메라 노출 조절
- 카메라 노출값 증감 버튼 제공  
- 실시간 영상 품질 조절 가능

---

## 주요 파일 및 역할

- **Picar.py** : PiCar 라인 트레이싱 및 MQTT 통신  
- **Robot_Arm_Control.py**, **Robot_Arm_Main.py** : 로봇 팔 제어 및 비전 인식, 센서 처리  
- **아두이노 펌웨어(AR_MAIN.ino, ArCAR.ino, MQTT_FW_UPDATE_ARCAR.ino)** : 아두이노 카 컨베이어 및 MQTT 제어  
- **Main.cs (C# UI)** : 공장 주문 관리, 영상 모니터링, 긴급 정지 및 재가동 UI  
- **Login.cs** : UI 로그인 및 사용자 권한 처리  
- **EmergencyHelper.cs**, **EmergencyDetailForm.cs** : 비상 상황 로그 저장 및 상세 조회  
- **DBHelper.cs** : DB 연결 및 주문/로그 데이터 관리  
- **ChartHelper.cs** : 연도별 제품 누적 판매량 데이터 조회 및 차트 표시  
- **CameraManager.cs** : 카메라 영상 캡처 및 YOLO 객체 탐지 처리

---

## 시스템 구성도

- **PiCar (Raspberry Pi)**
  - 3개 라인 센서, 2개 DC 모터, 1개 서보 모터  
  - MQTT 클라이언트 및 라인 트레이싱 알고리즘  

- **Robot Arm (Raspberry Pi + 서보 4개)**
  - 집기 및 적재 동작  
  - 카메라 비전(템플릿 매칭)  
  - 초음파 센서 2개  
  - MQTT 클라이언트  

- **아두이노 카**
  - 컨베이어 벨트 2대 및 서보 게이트  
  - RGB LED, 초음파 센서  
  - MQTT 클라이언트  

- **PC UI (Windows Forms, C#)**
  - 주문 현황 및 차량 관리  
  - 카메라 영상 모니터링 및 YOLO 객체 탐지  
  - 긴급 정지, 재가동 및 로그 관리  
  - 차트 시각화  

---

## 참고 및 문의
- MQTT Broker IP 및 포트는 각 구성 요소에서 동일하게 설정해야 합니다.
